# kouta-indeksoija-service

[Ks. katkoton indeksointi](README_INDEKSOINTI.md)

## Usage

### Pre configuration

To run the application locally, copy dev_resources/config.edn.template to dev_resources/config.edn 
and replace all `<fillme>` fields with actual values (get from QA common.properties). This config file is ignored in 
Git and should not be committed in the future.

### REPL

The dev and test profiles configurations are separated for the repl to ensure that
tests use different indices than development in elasticsearch. This might seem trivial,
but when hacking manually you don't want the test cases to nuke your data when autotesting.

#### Repl for development

During development it's easy to test what you have done by using a REPL. This works best 
with IDEA and cursive (others also, but the instructions here apply for Cursive).

Create a REPL run configuration. When you import the project one should be created for you.
If this is not the case, right click project.clj and select run. Then edit the configuration:

* Name it something like Dev REPL
* Add a JVM argument `-Dtest=false`
* When you start the repl type `(go)` to activate mount.core (brings settings to namespaces).

#### Repl for autotesting

Create another repl configuration, e.g. Test repl and add JVM argument `-Dtest=true`.

To run tests every time code is changed:
* `(use 'midje.repl)` (no need to use `(go)` here)
* `(autotest)`

### Tests

To run tests from command line use commands `lein test` or `lein autotest`

To run single test from command line use command `lein test kouta-indeksoija-service.elastic-client-test`.

Tests require that Docker is installed and Docker daemon is up and running. It
is possible to filter out tests that require Docker by adding filter, ie
`lein test :filter -docker` or `lein autotest :filter -docker`. These tests include
at least those that test SQS integration.


### Running the application locally

#### Requirements

##### Elasticsearch
Application requires a local Elasticsearch **(version 6.8.x)** index listening on port 9200. On Mac you can
install Elasticsearch with `brew install elasticsearch@6` and run with `brew services start elasticsearch` from
console, it will by default run on correct port. Correctly running Elasticsearch should answer in address `http://localhost:9200`

If all else fails you can install Elasticsearch directly from `https://www.elastic.co/downloads/past-releases/elasticsearch-6-8-12`

##### SQS
Application requires a local SQS on port 4576. SQS can be started with `tools\start_localstack`
and stopped with `tools\stop_localstack`, this requires that Docker is installed.

`tools\send_local` can be used to send messages to local queues.

##### Notifier
The application can notify others when information is indexed. This is controlled with `:notifier-targets`
value in `dev_resources/config.edn`. It should be defaulted to `""`, ie. no changes will be sent.

When wanting to validate locally that the notifications are working, one of the easiest way is with `dummy-web-server.py` in `tools`:
* Run `python2 tools/dummy-web-server.py 9900` to start it in port 9900.
* Change `:notifier-targets` in `dev_resources/config.edn` to `"http://localhost:9900"`
* You can edit the script to set the return code and headers.

The script will log every access to console.

#### Running

Running the application or tests from the commandline work with the aliases provided in
project.clj. 

To run the application: `lein run`

Ui can be found in: [http://localhost:3000/kouta-indeksoija/ui/index.html]

Running the app itself from the repl doesn't seem worth while.

### Nuking ElasticSearch settings

If you need to nuke ElasticSearch analyze settings, there are two tools that can be used test different settings and see how 
they affect queries and word analysis.

`test/misc/analyze_settings_test_tool.clj` can be used if you want to test how different analyze settings affect queries.
It mimics both nested structure in kouta-indeksoija search indexes and search queries generated by konfo-backend for koulutus
and oppilaitos searches.

`test/misc/analyzers_test_tool.clj` can be used to test how different search analyze settings handle different words and phraises.

Both tools have main method and they can be run for example in Idea by choosing run command when clicking right mouse button. 
Make sure you have test profile enabled in `Leiningen Projects/Profiles`.

### Configuration

App config is handled with Mount, cprops and in (mostly dev) cases with environment variables. To add a conf parameter
to the application, add it to dev_resources/config.edn (for development) AND oph-configuration/config.edn.template. In
order for the template file to work in non-local environments, the variable must also be added to the variable file in
git@git.oph.ware.fi:environment-{ophitest|ophp|ophprod|vagrant}.git in deploy/<env>_vars.yml.

NOTE: The cron-string variable roughly follows cron scheduler syntax with a few alterations shown 
[here](http://www.quartz-scheduler.org/documentation/quartz-2.x/tutorials/crontrigger.html).

## License

Copyright (c) 2017 The Finnish National Board of Education - Opetushallitus

For details see LICENSE.txt
















# kouta-indeksoija-service


## 1. Palvelun tehtävä

Indeksoi Elasticsearchiin koulutustarjonnan dataa, jotta sitä voidaan jakaa tehokkaasti eri palveluille, erityisesti 
konfo-ui:lle (beta.opintopolku.fi) ja sen koulutushaulle. 

## 2. Arkkitehtuuri

Kouta-indeksoija on clojurella toteutettu ring/compojure/compojure-api web API. Indeksoija kuuntelee kouta-backendin
lähettämiä sqs-viestejä ja viestin saatuaan hakee viestissä olleella id:llä entiteetin tiedot kouta-backendin 
rajapinnasta ja indeksoi tiedot Elasticsearchiin. Pyörittää myös cron jobia joka tarkastaa kouta-backendin muuttuneet
tiedot siinä tapauksessa että jokin tieto on jäänyt indeksoimatta.

Kouta-indeksoijaan integroituvia oph:n palveluja on mm. konfo-backend, kouta-internal, kouta-external. 

Indeksoijan käyttämät tietolähteet:

| Tietolähde    | Haettavat tiedot                                                                                                            |
|---------------|-----------------------------------------------------------------------------------------------------------------------------|
| eperusteet    | Ammatillisten koulutusten eperusteet sekä osaamisalojen ja tutkinnon osien kuvaukset                                        |
| koodisto      | Konfo-ui:ssa tarvittavien koodistojen koodien lokalisaatiot. Lisäksi tarvittavat koodirelaatiot ja niidenkin lokalisaatiot. |
| kouta-backend | Koulutukset, koulutusten toteutukset, hakukohteet, haut, valintaperustekuvaukset ja SORA-kuvaukset                          |
| lokalisaatio  | Konfo-ui:ssa käyttäjille näytettävät tekstit kolmella eri kielellä (suomi, ruotsi ja englanti)                              |
| organisaatio  | Koulutustoimijoiden, oppilaitosten ja toimipisteiden perustiedot ja niiden organisaatiohierarkia                            |

## 3. Kehitysympäristö

### 3.1. Esivaatimukset

What other software you need to have installed on your local machine in order to set up a development environment?
Is there are separate file for environmental variables? How does a developer get one that works?
Are other changes - such as /etc/hosts, port-forwardings - needed?

### 3.2. Testien ajaminen

How to run all tests locally. If there are separate unit, integration and acceptance/e2e tests, remember to
describe here how to run any/all of them.

### 3.3. Ajaminen lokaalisti

How to start the application locally.

What URL(s) to use to access the locally running application?

What kind of credentials do you need to access all relevant pieces of the application?

If there are multiple distinct user roles, you need a test user account for each of them.

### 3.6. Kehitystyökalujen setup

If there are some special tricks needed to get the project working in IDEA/Eclipse/something other, then
describe them here. Preferably attach screenshots, if applicable.

### 3.7. Versiohallinta

If using git:
- What kind of git workflow is used in this project. Merge or rebase?
- Should commits be squashed, and if yes, in which circumstances?
- What are the requirements for commit messages?
- What are the naming conventions for branches?
- All other git-related stuff that comes to mind.

If using some other version control than git:
- The same as above, as is relevant to the version control system in use.

### 3.8. How to make a production data dump and import it into the local development environment

Sometimes you run into hard-to-reproduce bugs, which manifest themselves only with production data.

In those cases it is extremely useful to be able to do a data dump from production and set up the local
development environment with production data.

Describe how to do that here.

## 4. Test environment

### 4.1. Access

- The URL where the test environment of the application can be found.
  Also, all other URLs which point to something relevant, like for example an administrator UI, etc.
- The credentials to use in the test environment. For example, username and password. If there are multiple
  distinct user roles with different access to some parts of the application, there must be multiple developer accounts
  in order to be able to test all of them.
- If a VPN, SSH tunneling or some other similar way to access the test environment is required,
  describe the steps needed here.

### 4.2. Deployment

How a deployment is done.

### 4.3. Verifying that a deployment was successful

The steps needed to verify that a new version is running in the test environment successfully.

#### 4.3.1. Automated test cases

Tests (scripts or otherwise) that you have to run in order to ensure that a deployment was successful.

#### 4.3.2. Manual test cases

Things that you have to test manually in order to ensure that a deployment was successful.

### 4.4. Rollback

How to restore the previous version of the software when a deployment goes wrong?

### 4.5. Logs

Where are the logs, how to change logging levels, etc.

### 4.6. Monitoring

What kind of monitoring is there in the test environment, if any.

## 5. Production environment

### 5.1. Access

- The URL where the production environment of the application can be found.
  Also, all other URLs which point to something relevant, like for example an administrator UI, etc.
- The credentials to use in the production environment. For example, username and password. If there are multiple
  distinct user roles with different access to some parts of the application, there must be multiple developer accounts
  in order to be able to test all of them.
- If a VPN, SSH tunneling or some other similar way to access the production environment is required,
  describe the steps needed here.

### 5.2. Deployment

How a production deployment is done.

### 5.3. Verifying that a deployment was successful

The steps needed to verify that a new version is running in production successfully.

#### 5.3.1. Automated test cases

Tests (scripts or otherwise) that you have to run in order to ensure that a deployment was successful.

#### 5.3.2. Manual test cases

Things that you have to test manually in order to ensure that a deployment was successful.

### 5.4. Rollback

How to restore the previous version of the software when a deployment goes wrong?

### 5.5. Logs

Where are the logs, how to change logging levels, etc.

### 5.6. Monitoring

What things are monitored? Which tools are used? How to access the UI(s) of the monitoring tools?

## 6. Continuous integration

Where is/are the CI(s) for this project?

## 7. Code style

Coding conventions, linting, etc.

## 8. Operating instructions for manual and semi-manual processes

Many applications require some manual processes which occur from time to time, like for example
adding new users, doing manual database maintenance work, creating monthly reports etc.

Describe how to do them here. The descriptions have to be detailed enough so that someone else can do them
with these instructions.

## 9. More useful information, Tips and Tricks

Other important or useful things to know.







